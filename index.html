<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calm Places Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- RIGHT SIDEBAR -->
  <div id="sidebar">
    <h2>Calm Places</h2>

    <input id="search" type="text" placeholder="Search calm places..." />

    <!-- ðŸ”¥ CHANGE 1 â€” New TYPE filter -->
    <select id="typeFilter">
      <option value="all">All Types</option>
      <option value="Park">Park</option>
      <option value="Cafe">Cafe</option>
      <option value="Quiet Space">Quiet Space</option>
    </select>
    <!-- ðŸ”¥ CHANGE END -->

    <div id="places-list"></div>
  </div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const defaultLocation = [41.024893, 28.958593];
    const map = L.map("map", { zoomControl: true }).setView(defaultLocation, 17);

    L.tileLayer(
      "https://api.maptiler.com/maps/dataviz/{z}/{x}/{y}.png?key=FTUnG51TBb8dHj8BnvBS",
      {
        tileSize: 512,
        zoomOffset: -1,
        minZoom: 1,
        attribution:
          '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> ' +
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }
    ).addTo(map);

    // Locate user
    map.locate({ setView: false, maxZoom: 17 });

    map.on("locationfound", e => {
      map.setView(e.latlng, 17);
      L.circleMarker(e.latlng, {
        radius: 8,
        color: "#136AEC",
        fillColor: "#2A93EE",
        fillOpacity: 1,
      })
      .addTo(map)
      .bindPopup("You are here");
    });

    map.on("locationerror", () => {
      L.circleMarker(defaultLocation, {
        radius: 8,
        color: "#136AEC",
        fillColor: "#2A93EE",
        fillOpacity: 1,
      }).addTo(map);
    });

    let markers = [];
    let placesData = [];

    // -------- LOAD POINTS --------
    fetch("points.json?v=" + Date.now())
      .then(resp => resp.json())
      .then(data => {
        placesData = data;
        renderPlacesList(data);

        markers = data.map(place => {
          const marker = L.marker([place.lat, place.lng]);

          /* ðŸ”¥ CHANGE 2 â€” Replace old fields */
          marker.title = place.title;
          marker.type = place.type;
          marker.picture = place.picture;
          marker.price = place.price;
          marker.openHours = place.openHours;
          /* ðŸ”¥ CHANGE END */

          /* ðŸ”¥ CHANGE 3 â€” New Popup */
          marker.addTo(map).bindPopup(`
            <div style="text-align:center">
              <img src="${place.picture}" width="120" style="border-radius:8px;margin-bottom:6px">
              <h3>${place.title}</h3>
              <p><b>Type:</b> ${place.type}</p>
              <p><b>Price:</b> ${place.price}</p>
              <p><b>Open:</b> ${place.openHours}</p>
            </div>
          `);
          /* ðŸ”¥ CHANGE END */

          return marker;
        });
      });

    // -------- SEARCH + FILTER --------
    document.getElementById("search").addEventListener("input", filterMarkers);
    document.getElementById("typeFilter").addEventListener("change", filterMarkers);

    function filterMarkers() {
      const text = document.getElementById("search").value.toLowerCase();
      const typeSel = document.getElementById("typeFilter").value;

      markers.forEach(marker => map.removeLayer(marker));

      /* ðŸ”¥ CHANGE 4 â€” Search by title + type */
      let filtered = markers.filter(m =>
        (m.title.toLowerCase().includes(text) ||
         m.type.toLowerCase().includes(text)) &&
        (typeSel === "all" || m.type === typeSel)
      );
      /* ðŸ”¥ CHANGE END */

      filtered.forEach(m => m.addTo(map));

      renderPlacesList(
        placesData.filter(p =>
          (p.title.toLowerCase().includes(text) ||
           p.type.toLowerCase().includes(text)) &&
          (typeSel === "all" || p.type === typeSel)
        )
      );
    }

    // -------- SIDEBAR LIST --------
    function renderPlacesList(places) {
      const list = document.getElementById("places-list");
      list.innerHTML = "";

      places.forEach(place => {
        const item = document.createElement("div");
        item.className = "place-item";

        /* ðŸ”¥ CHANGE 5 â€” Sidebar with image + type + price */
        item.innerHTML = `
          <img src="${place.picture}" class="thumb">
          <div class="info">
            <b>${place.title}</b><br>
            <span>${place.type}</span><br>
            <small>${place.price} â€¢ ${place.openHours}</small>
          </div>
        `;
        /* ðŸ”¥ CHANGE END */

        item.onclick = () => map.setView([place.lat, place.lng], 18);
        list.appendChild(item);
      });
    }
  </script>
</body>
</html>
